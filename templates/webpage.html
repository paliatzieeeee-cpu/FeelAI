<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>AI Vision Chat</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='webpage.css') }}">
</head>
<body>
  <div class="app">
    <header class="topbar">
      <div class="brand">
        <div class="dot"></div>
        <div>
          <div class="title">FeelAI</div>
          <div class="subtitle">The №1 emotion detector</div>
        </div>
      </div>

      <form class="clearform" action="{{ url_for('clear_chat') }}" method="POST">
        <button class="btn secondary" type="submit">Clear Chat</button>
      </form>
    </header>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="alerts">
          {% for category, msg in messages %}
            <div class="alert {{ category }}">{{ msg }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <main class="chat">
      {% if chat|length == 0 %}
        <div class="empty">Upload an image to start.</div>
      {% endif %}

      {% for m in chat %}
        <div class="msg {{ m.role }}">
          <div class="bubble">

            {% if m.role == "user" and m.image_url %}
              <div class="imgwrap">
                <img src="{{ m.image_url }}" alt="uploaded image"/>
              </div>
              <!-- Δείχνουμε το filename σε μικρό meta αντί για μεγάλο bubble text -->
              {% if m.content %}
                <div class="meta">{{ m.content }}</div>
              {% endif %}
            {% endif %}

            {% if m.role != "user" %}
              <div class="text">{{ m.content }}</div>
            {% endif %}

            {% if m.role == "bot" %}
              <div class="meta">
                {% if m.latency %}Latency: {{ m.latency }}s{% endif %}
              </div>

              {% if m.detections and m.detections|length > 0 %}
                <div class="meta">Faces detected: {{ m.detections|length }}</div>
                <div class="meta">Detections:</div>
                <div class="chips">
                  {% for d in m.detections %}
                    <span class="chip">{{ d.label }} ({{ "%.2f"|format(d.confidence) }})</span>
                  {% endfor %}
                </div>
              {% else %}
                <div class="meta">Detections: none</div>
              {% endif %}
            {% endif %}

          </div>
        </div>
      {% endfor %}
    </main>

    <footer class="composer">
      <form class="composeform" action="{{ url_for('chat') }}" method="POST" enctype="multipart/form-data">
        <div class="row">
          <input type="file" name="image" accept="image/png,image/jpeg,image/webp" required>
          <button class="btn" type="submit">Upload</button>
        </div>

        <div class="row small">
          <label>
            Prompt style
            <select name="prompt_style">
              <option value="focus_emotion" selected>focus_emotion</option>
              <option value="bullet_then_summary">bullet_then_summary</option>
              <option value="concise">concise</option>
            </select>
          </label>

          <label>
            Detector
            <select name="detector_backend">
              <option value="opencv" selected>opencv</option>
              <option value="mtcnn">mtcnn</option>
              <option value="retinaface">retinaface</option>
            </select>
          </label>
        </div>

        <div class="hint">
          Η σελίδα κάνει refresh μετά το upload και εμφανίζει αποτέλεσμα σαν chat history.
        </div>
      </form>
    </footer>
  </div>
</body>
</html>
